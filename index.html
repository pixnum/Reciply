<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recipe Generator — Offline</title>
<style>
  :root{--accent:#ff7043;--bg:#f7f7f8;--card:#fff;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;color:#111;line-height:1.4}
  header{background:var(--accent);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:18px}
  .actions{display:flex;gap:8px;align-items:center}
  main{max-width:1100px;margin:18px auto;padding:12px}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  label{font-size:13px;color:var(--muted);display:block;margin-top:8px}
  input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);font-size:14px}
  textarea{min-height:90px;resize:vertical}
  button{background:var(--accent);color:#fff;border:none;cursor:pointer}
  .small-btn{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06);padding:8px;border-radius:8px;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .recipe-card{border:1px solid rgba(0,0,0,0.06);padding:10px;border-radius:8px;margin-bottom:8px}
  .flex{display:flex;gap:8px;align-items:center}
  .hidden{display:none}
  .shopping-item{display:flex;align-items:center;gap:8px;padding:6px 0}
  .nutrition-line{font-size:13px;color:#333;margin-top:6px}
  .step-nut{font-size:13px;color:var(--muted)}
  .print-only{display:none}
  .small-input{width:110px;padding:8px;border-radius:6px}
  .inline-edit{display:flex;gap:6px;align-items:center}
  .inline-edit input{width:80px;padding:6px}
  .unit-select{width:110px;padding:6px}
  .help-btn{background:rgba(255,255,255,0.12);color:#fff;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.06);cursor:pointer}
  /* Full-page help overlay */
  .help-overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.96),rgba(2,6,23,0.98));color:#e6eef8;z-index:50;display:flex;flex-direction:column;overflow:auto}
  .help-header{display:flex;justify-content:space-between;align-items:center;padding:20px 28px;border-bottom:1px solid rgba(255,255,255,0.04)}
  .help-body{padding:20px 28px;display:flex;gap:24px;flex-direction:column;max-width:1100px;margin:0 auto}
  .help-section{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px}
  .help-title{font-size:20px;margin:0 0 8px 0}
  .help-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.help-grid{grid-template-columns:1fr}}
  .help-ico{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.06);display:inline-flex;align-items:center;justify-content:center;margin-right:10px}
  .ftip{position:fixed;left:12px;bottom:12px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 8px 30px rgba(2,6,23,0.2);z-index:60}
  .back-btn{background:rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .center-back{display:block;margin:0 auto 12px auto;padding:10px 18px;font-size:1.05rem;background:rgba(255,255,255,0.08);border-radius:8px;border:1px solid rgba(255,255,255,0.06);color:#fff}
  .muted-light{color:rgba(230,238,248,0.85)}
  /* visible when printing */
  @media print{body *{visibility:hidden} .print-only, .print-only *{visibility:visible} .print-only{position:fixed;left:0;top:0;width:100%}}
</style>
</head>
<body>
<header>
  <h1>Recipe Generator — Offline</h1>
  <div class="actions">
    <div id="regionLabel" class="muted">Unit: Metric</div>
    <button id="toggleUnitsBtn" class="small-btn" title="Toggle units">Toggle Units</button>
    <button id="helpOpenBtn" class="help-btn" title="Open Help">Help</button>
  </div>
</header>

<main id="mainApp">
  <div class="grid">
    <!-- left: form -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Create / Edit Recipe</h2>

      <label>Recipe name</label>
      <input id="recipeName" placeholder="e.g. Chicken Curry">

      <label>Servings (recipe yields)</label>
      <input id="baseServings" type="number" min="1" value="1" class="small-input">

      <label>Ingredients (one per line, include measurement) — e.g. <code>200 g chicken breast</code></label>
      <textarea id="ingredients" placeholder="200 g chicken breast&#10;100 g tomato&#10;15 ml olive oil"></textarea>

      <label>Instructions (one step per line; optional timer like <code>[10m]</code>)</label>
      <textarea id="instructions" placeholder="Boil chicken [20m]&#10;Sauté onions [5m]"></textarea>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="saveBtn">Save Recipe</button>
        <button id="clearBtn" class="small-btn">Clear</button>
      </div>

      <div style="margin-top:12px" class="muted">Tip: set the base servings the recipe yields — scaling will use this.</div>

      <div id="generatedArea" style="margin-top:14px" class="hidden card">
        <h3 style="margin:0">Nutrition (approx)</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div class="muted">Scale to</div>
          <input id="displayServings" type="number" min="1" value="1" class="small-input">
          <div class="muted">servings</div>
        </div>
        <div id="nutritionSummary" class="nutrition-line muted" style="margin-top:8px">N/A</div>
        <div id="perStepNutrition" style="margin-top:8px"></div>
        <div style="margin-top:8px" class="flex">
          <button id="printRecipeBtn" class="small-btn">Print Recipe</button>
        </div>
      </div>
    </section>

    <!-- right: recipes list -->
    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>My Recipes</strong>
          <input id="search" placeholder="Search..." class="muted" style="width:55%">
        </div>
        <div id="recipesList" style="margin-top:10px;max-height:62vh;overflow:auto"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="refreshBtn" class="small-btn">Refresh</button>
          <button id="clearAllBtn" class="small-btn">Clear All</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="card">
        <strong>Quick Actions</strong>
        <div style="margin-top:8px" class="flex">
          <button id="randomSuggest" class="small-btn">Suggest Random</button>
          <button id="importSample" class="small-btn">Load Sample</button>
        </div>
        <p class="muted" style="margin-top:8px">All data stored locally in your browser.</p>
      </div>
    </aside>
  </div>

  <!-- Cook Mode -->
  <div id="cookPanel" class="card hidden" style="margin-top:14px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong id="cookTitle">Cook Mode</strong>
      <div class="muted" id="cookProgress"></div>
    </div>
    <div style="margin-top:8px">
      <div id="stepText" style="font-size:18px"></div>
      <div id="timerText" class="muted" style="margin-top:6px"></div>
      <div id="stepNutritionText" class="step-nut" style="margin-top:6px"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="prevStepBtn" class="small-btn">Previous</button>
      <button id="nextStepBtn" class="small-btn">Next</button>
      <button id="stopCookBtn" class="small-btn">Exit</button>
    </div>
  </div>

  <!-- Shop Panel -->
  <div id="shopPanel" class="card hidden" style="margin-top:14px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong id="shopTitle">Shopping List</strong>
      <div class="muted">Per recipe</div>
    </div>
    <div id="shopItems" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="closeShopBtn" class="small-btn">Close</button>
      <button id="clearShopBtn" class="small-btn">Clear Checked</button>
    </div>
  </div>

  <!-- Print view -->
  <div id="printView" class="print-only hidden" style="padding:20px;background:#fff">
    <div id="printContent"></div>
  </div>

  <div style="height:20px"></div>
  <footer class="muted" style="text-align:center">© Manik Roy 2025</footer>
</main>

<!-- Full-page Help overlay -->
<div id="helpOverlay" class="help-overlay hidden" role="dialog" aria-hidden="true">
  <div class="help-header">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="font-size:20px;font-weight:600">Help — How to use Recipe Generator</div>
      <div class="muted-light">Offline • Built-in nutrition DB</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <!-- Small top-right back as well for accessibility -->
      <button id="helpCloseTop" class="back-btn">Back to App</button>
    </div>
  </div>
  <div class="help-body">
    <button id="backToAppBtn" class="center-back">⬅ Back to App</button>

    <div style="display:flex;justify-content:space-between;gap:20px;align-items:flex-start">
      <div style="flex:1">
        <div class="help-section">
          <div style="display:flex;align-items:center">
            <div class="help-ico">📘</div>
            <div>
              <div class="help-title">1. Adding a Recipe</div>
              <div class="muted-light">Enter a name, base servings, list ingredients (one per line) and instructions (one per line). Use measurement units such as <code>g, kg, ml, l, cup, tbsp, tsp, oz, lb</code>. For timers in steps add <code>[10m]</code>.</div>
            </div>
          </div>
        </div>

        <div class="help-section" style="margin-top:12px">
          <div style="display:flex;align-items:center">
            <div class="help-ico">✏️</div>
            <div>
              <div class="help-title">2. Editing Ingredients</div>
              <div class="muted-light">Open the <strong>Shop</strong> panel for a recipe and click <strong>Edit Ingredients</strong>. Adjust quantity/unit/name inline then click <strong>Update</strong> — nutrition recalculates automatically.</div>
            </div>
          </div>
        </div>

        <div class="help-section" style="margin-top:12px">
          <div style="display:flex;align-items:center">
            <div class="help-ico">⏱️</div>
            <div>
              <div class="help-title">3. Cooking Mode & Timers</div>
              <div class="muted-light">Click <strong>Cook</strong> on a recipe. Use Previous / Next to move between steps. Steps with timers (e.g. <code>[5m]</code>) show a countdown and notify when done.</div>
            </div>
          </div>
        </div>
      </div>

      <div style="width:320px">
        <div class="help-section">
          <div style="display:flex;align-items:center">
            <div class="help-ico">🧾</div>
            <div>
              <div class="help-title">4. Shop & Print</div>
              <div class="muted-light">Open <strong>Shop</strong> to view per-recipe shopping items and tick off purchased items. Use <strong>Print Recipe</strong> to get a print-friendly view.</div>
            </div>
          </div>
        </div>

        <div class="help-section" style="margin-top:12px">
          <div style="display:flex;align-items:center">
            <div class="help-ico">⚙️</div>
            <div>
              <div class="help-title">5. Units & Scaling</div>
              <div class="muted-light">Toggle Metric/Imperial with the button in the header. Set the recipe's base servings when saving; use <strong>Scale to</strong> for desired servings.</div>
            </div>
          </div>
        </div>

        <div class="help-section" style="margin-top:12px">
          <div style="display:flex;align-items:center">
            <div class="help-ico">⚠️</div>
            <div>
              <div class="help-title">6. Nutrition Notes</div>
              <div class="muted-light">Nutrition values are approximate (DB per 100 g). Best matching occurs when ingredient names match DB keys (e.g., <em>chicken breast</em>, <em>olive oil</em>). Unmatched items are distributed across steps.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px" class="help-section">
      <div class="help-title">Quick Tips</div>
      <div class="anchor-row">
        <div class="muted-light">• Use exact food names for best nutrition matching.</div>
        <div class="muted-light">• Edit ingredients to fix mismatches.</div>
        <div class="muted-light">• Recipes are stored locally — clear via browser settings.</div>
        <div class="muted-light">• App runs fully offline; no internet required after opening file.</div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
      <button id="backToAppBtn2" class="back-btn">Back to App</button>
    </div>

    <footer style="text-align:center;margin-top:18px;font-size:0.9rem;color:rgba(230,238,248,0.7)">© Manik Roy 2025</footer>
  </div>
</div>

<!-- First-time tip (appears bottom-left) -->
<div id="firstTip" class="ftip hidden" role="dialog" aria-hidden="true">
  <div style="font-weight:600;margin-bottom:6px">Welcome to Recipe Generator</div>
  <div class="muted" style="font-size:13px;max-width:260px">Tip: Click <strong>Help</strong> (top-right) for a quick tour. You can edit ingredients in the shopping panel and adjust servings to scale nutrition.</div>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="openHelpFromTip" class="small-btn">Open Help</button>
    <button id="dismissTip" class="small-btn">Dismiss</button>
  </div>
</div>

<script>
/* ---------------------------
   Nutrition DB (representative; extendable)
   Values per 100 g (approx)
   --------------------------- */
const BIG_NUTRITION_DB = {
  "chicken breast": { cal:165, protein:31, carbs:0, fat:3.6 },
  "chicken thigh": { cal:209, protein:26, carbs:0, fat:10.9 },
  "beef": { cal:250, protein:26, carbs:0, fat:15 },
  "pork": { cal:242, protein:27, carbs:0, fat:14 },
  "salmon": { cal:208, protein:20, carbs:0, fat:13 },
  "tuna": { cal:130, protein:29, carbs:0, fat:1 },
  "egg": { cal:155, protein:13, carbs:1.1, fat:11 },
  "milk": { cal:60, protein:3.2, carbs:5, fat:3.3 },
  "olive oil": { cal:884, protein:0, carbs:0, fat:100 },
  "butter": { cal:717, protein:0.85, carbs:0.06, fat:81 },
  "rice": { cal:130, protein:2.7, carbs:28, fat:0.3 },
  "pasta": { cal:131, protein:5, carbs:25, fat:1.1 },
  "tomato": { cal:18, protein:0.9, carbs:3.9, fat:0.2 },
  "onion": { cal:40, protein:1.1, carbs:9.3, fat:0.1 },
  "garlic": { cal:149, protein:6.4, carbs:33, fat:0.5 },
  "potato": { cal:77, protein:2, carbs:17, fat:0.1 },
  "cheddar cheese": { cal:403, protein:25, carbs:1.3, fat:33 },
  "tofu": { cal:76, protein:8, carbs:1.9, fat:4.8 },
  "lentils": { cal:116, protein:9, carbs:20, fat:0.4 },
  "spinach": { cal:23, protein:2.9, carbs:3.6, fat:0.4 },
  "carrot": { cal:41, protein:0.9, carbs:10, fat:0.2 },
  "apple": { cal:52, protein:0.3, carbs:14, fat:0.2 },
  "banana": { cal:89, protein:1.1, carbs:23, fat:0.3 },
  "olive": { cal:115, protein:0.8, carbs:3.8, fat:10.7 },
  "sugar": { cal:387, protein:0, carbs:100, fat:0 },
  "honey": { cal:304, protein:0.3, carbs:82.4, fat:0 },
  "soy sauce": { cal:53, protein:8, carbs:4.9, fat:0.1 }
  /* Add more entries as needed — you can paste a 200+ list to extend this object */
};

/* synonyms */
const SYNONYMS = {
  "tomatoes":"tomato",
  "olive-oil":"olive oil",
  "boneless chicken":"chicken breast",
  "brown rice":"rice"
};

/* Unit parsing & helpers */
const UNIT_MAP = {
  "g": {to_g:1,type:'mass'}, "gram":{to_g:1,type:'mass'}, "grams":{to_g:1,type:'mass'},
  "kg":{to_g:1000,type:'mass'},
  "mg":{to_g:0.001,type:'mass'},
  "ml":{to_ml:1,type:'vol'}, "l":{to_ml:1000,type:'vol'},
  "tsp":{to_ml:4.928,type:'vol'}, "tbsp":{to_ml:14.787,type:'vol'},
  "cup":{to_ml:240,type:'vol'}, "oz":{to_g:28.3495,type:'mass'}, "lb":{to_g:453.592,type:'mass'}
};
function evalFraction(frac){ if (typeof frac !== 'string') return parseFloat(frac); if (frac.includes(' ')){ const parts=frac.split(' '); return parseFloat(parts[0])+evalFraction(parts[1]); } if (frac.includes('/')){ const [a,b]=frac.split('/'); return parseFloat(a)/parseFloat(b); } return parseFloat(frac); }
function normalizeText(s){ return (s||'').toLowerCase().replace(/[.,()]/g,'').replace(/\s+/g,' ').trim(); }

/* parse ingredient */
function parseIngredientLine(line){
  const raw = (line||'').trim();
  if (!raw) return null;
  const regex = /^([\d\s\/.]+)?\s*([a-zA-Z]+)?\s*(.*)$/;
  const m = raw.match(regex);
  if (!m) return { raw, name: raw, quantity: null, quantity_unit: null };
  const qtyRaw = (m[1]||'').trim();
  const unitRaw = (m[2]||'').toLowerCase();
  const rest = (m[3]||'').trim();
  if (!qtyRaw) return { raw, name: rest || unitRaw || raw, quantity: null, quantity_unit: null };
  const qty = evalFraction(qtyRaw);
  if (UNIT_MAP[unitRaw]){
    const u = UNIT_MAP[unitRaw];
    if (u.type === 'mass') return { raw, name: rest||unitRaw, quantity: qty * (u.to_g||1), quantity_unit: 'g' };
    if (u.type === 'vol') return { raw, name: rest||unitRaw, quantity: qty * (u.to_ml||1), quantity_unit: 'ml' };
  }
  return { raw, name: ((unitRaw + ' ' + rest).trim()||raw), quantity: qty, quantity_unit: unitRaw };
}

/* match DB key */
function matchNutritionKey(name){
  if (!name) return null;
  let n = normalizeText(name);
  if (SYNONYMS[n]) return SYNONYMS[n];
  if (BIG_NUTRITION_DB[n]) return n;
  let best=null, bestLen=0;
  for (const key in BIG_NUTRITION_DB){
    if (n.includes(key) && key.length > bestLen){ best = key; bestLen = key.length; }
  }
  if (best) return best;
  const nameWords = n.split(' ');
  for (const key in BIG_NUTRITION_DB){
    for (const w of nameWords){
      if (w && key.includes(w) && key.length > bestLen){ best = key; bestLen = key.length; }
    }
  }
  return best;
}

/* Unit display & formatting */
let UNIT_SYSTEM = localStorage.getItem('unit_system_vgen') || 'metric';
function setUnitSystem(sys){ UNIT_SYSTEM=sys; localStorage.setItem('unit_system_vgen', sys); document.getElementById('regionLabel').textContent = 'Unit: ' + (sys==='metric'?'Metric':'Imperial'); renderRecipes(); }
function gramsToOz(g){ return g/28.3495; }
function mlToCups(ml){ return ml/240; }
function formatIngredientForDisplay(line, scale=1){
  const p = parseIngredientLine(line);
  if (!p) return line;
  if (p.quantity == null) return p.name;
  const qty = p.quantity * scale;
  if (p.quantity_unit === 'g'){
    if (UNIT_SYSTEM==='metric') return `${Math.round(qty)} g ${p.name}`;
    else return `${gramsToOz(qty).toFixed(2)} oz ${p.name}`;
  } else if (p.quantity_unit === 'ml'){
    if (UNIT_SYSTEM==='metric') return `${Math.round(qty)} ml ${p.name}`;
    else return `${mlToCups(qty).toFixed(2)} cup(s) ${p.name}`;
  } else {
    return p.raw;
  }
}

/* App state & storage */
let recipes = JSON.parse(localStorage.getItem('recipes_vgen') || '[]');
/* If empty — prefill with examples */
if (!recipes || recipes.length === 0) {
  recipes = [
    {
      name: 'Spicy Tomato Pasta',
      servings: 2,
      ingredients: ['200 g pasta','150 g tomato','10 g garlic','15 ml olive oil','5 g basil'],
      instructions: [{step:'Boil pasta',time:10},{step:'Sauté garlic and tomato',time:5},{step:'Mix pasta and sauce',time:2}],
      shoppingList: [{item:'200 g pasta',checked:false},{item:'150 g tomato',checked:false}],
      created: Date.now()
    },
    {
      name: 'Simple Chicken Stirfry',
      servings: 2,
      ingredients: ['250 g chicken breast','100 g bell pepper','30 ml soy sauce','15 ml olive oil','50 g onion'],
      instructions: [{step:'Slice and marinate chicken',time:0},{step:'Fry chicken',time:8},{step:'Add veggies & sauce',time:5}],
      shoppingList: [{item:'250 g chicken breast',checked:false},{item:'100 g bell pepper',checked:false}],
      created: Date.now()
    }
  ];
  localStorage.setItem('recipes_vgen', JSON.stringify(recipes));
}

function saveAll(){ localStorage.setItem('recipes_vgen', JSON.stringify(recipes)); }

/* Rendering & main UI logic */
const recipesListEl = document.getElementById('recipesList'), searchEl = document.getElementById('search');

function renderRecipes(){
  const q = (searchEl.value||'').toLowerCase();
  recipesListEl.innerHTML = '';
  if (!recipes.length) { recipesListEl.innerHTML = '<div class="muted">No saved recipes</div>'; return; }
  recipes.forEach((r, idx)=>{
    if (q && !r.name.toLowerCase().includes(q)) return;
    const el = document.createElement('div'); el.className='recipe-card';
    const ingrDisplay = r.ingredients.map(l=>formatIngredientForDisplay(l,1)).join('<br>');
    const stepsPreview = r.instructions.map(s=> s.step + (s.time? ` [${s.time}m]` : '')).join('<br>');
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <strong>${r.name}</strong>
      <div class="flex">
        <button class="small-btn" onclick="openCook(${idx})">Cook</button>
        <button class="small-btn" onclick="openShop(${idx})">Shop</button>
        <button class="small-btn" onclick="editRecipe(${idx})">Edit</button>
        <button class="small-btn" onclick="deleteRecipe(${idx})">Delete</button>
        <button class="small-btn" onclick="printRecipe(${idx})">Print</button>
      </div>
    </div>
    <div style="margin-top:8px" class="muted"><strong>Serves:</strong> ${r.servings} • <strong>Ingredients:</strong><br>${ingrDisplay}</div>
    <div style="margin-top:8px" class="muted"><strong>Steps:</strong><br>${stepsPreview}</div>`;
    recipesListEl.appendChild(el);
  });
}

/* Save recipe from form */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const name = (document.getElementById('recipeName').value||'').trim();
  const servings = Number(document.getElementById('baseServings').value) || 1;
  const ingrText = (document.getElementById('ingredients').value||'').trim();
  const instText = (document.getElementById('instructions').value||'').trim();
  if (!name || !ingrText || !instText){ alert('Fill name, servings, ingredients and instructions.'); return; }
  const ingredientLines = ingrText.split('\n').map(l=>l.trim()).filter(Boolean);
  const instructions = instText.split('\n').map(line=>{
    const tm = line.match(/\[(\d+)m\]/);
    const time = tm ? parseInt(tm[1],10) : 0;
    return { step: line.replace(/\[\d+m\]/,'').trim(), time };
  });
  const shoppingList = ingredientLines.map(it=>({ item: it, checked: false }));
  const recipe = { name, servings, ingredients: ingredientLines, instructions, shoppingList, created: Date.now() };
  const existing = recipes.findIndex(x=>x.name.toLowerCase()===name.toLowerCase());
  if (existing>=0) recipes[existing]=recipe; else recipes.unshift(recipe);
  saveAll(); clearForm(); renderRecipes(); computeAndShowNutrition(recipe);
});
function clearForm(){ document.getElementById('recipeName').value=''; document.getElementById('baseServings').value='1'; document.getElementById('ingredients').value=''; document.getElementById('instructions').value=''; document.getElementById('generatedArea').classList.add('hidden'); }
function editRecipe(i){
  const r = recipes[i]; if(!r) return;
  document.getElementById('recipeName').value = r.name;
  document.getElementById('baseServings').value = r.servings||1;
  document.getElementById('ingredients').value = r.ingredients.join('\n');
  document.getElementById('instructions').value = r.instructions.map(s=> s.step + (s.time?` [${s.time}m]`:'')).join('\n');
  window.scrollTo({top:0,behavior:'smooth'});
}
function deleteRecipe(i){ if(!confirm('Delete recipe?')) return; recipes.splice(i,1); saveAll(); renderRecipes(); }
document.getElementById('clearAllBtn').addEventListener('click', ()=>{ if(!confirm('Delete ALL recipes?')) return; recipes=[]; saveAll(); renderRecipes(); });
document.getElementById('refreshBtn').addEventListener('click', renderRecipes);

/* Per-recipe details & inline ingredient edit */
function openRecipeDetails(i){
  const r = recipes[i]; if(!r) return;
  const box = document.getElementById('shopItems'); box.innerHTML = '';
  const title = document.getElementById('shopTitle'); title.textContent = r.name + ' — Details (Edit ingredients)';
  r.ingredients.forEach((line, idx)=>{
    const p = parseIngredientLine(line);
    const div = document.createElement('div'); div.style.marginBottom='8px';
    const display = document.createElement('div'); display.className='muted'; display.textContent = line;
    const editRow = document.createElement('div'); editRow.className='inline-edit';
    const qtyInput = document.createElement('input'); qtyInput.type='text'; qtyInput.value = p && p.quantity ? (p.quantity_unit==='g'||p.quantity_unit==='ml' ? Math.round(p.quantity) : p.quantity) : '';
    qtyInput.placeholder = p && p.quantity ? '' : 'qty';
    const unitSelect = document.createElement('select'); unitSelect.className='unit-select';
    ['g','ml','oz','cup','tbsp','tsp','unit'].forEach(u=>{ const opt=document.createElement('option'); opt.value=u; opt.textContent=u; unitSelect.appendChild(opt); });
    if (p && p.quantity_unit === 'g') unitSelect.value = 'g';
    else if (p && p.quantity_unit === 'ml') unitSelect.value = 'ml';
    else unitSelect.value = 'g';
    const nameInput = document.createElement('input'); nameInput.type='text'; nameInput.value = p ? p.name : line; nameInput.style.width='200px';
    const updateBtn = document.createElement('button'); updateBtn.textContent='Update'; updateBtn.className='small-btn';
    updateBtn.addEventListener('click', ()=>{
      const newQtyRaw = qtyInput.value.trim();
      const chosenUnit = unitSelect.value;
      const newName = nameInput.value.trim();
      if (!newQtyRaw || !newName){ alert('Enter quantity and name'); return; }
      const newLine = `${newQtyRaw} ${chosenUnit} ${newName}`;
      r.ingredients[idx] = newLine;
      if (r.shoppingList && r.shoppingList[idx]) r.shoppingList[idx].item = newLine;
      saveAll();
      openRecipeDetails(i);
      computeAndShowNutrition(r);
      renderRecipes();
    });
    editRow.appendChild(qtyInput); editRow.appendChild(unitSelect); editRow.appendChild(nameInput); editRow.appendChild(updateBtn);
    div.appendChild(display); div.appendChild(editRow);
    box.appendChild(div);
  });
  const done = document.createElement('div'); done.style.marginTop='8px';
  const closeBtn = document.createElement('button'); closeBtn.textContent='Done'; closeBtn.className='small-btn';
  closeBtn.addEventListener('click', ()=> document.getElementById('shopPanel').classList.add('hidden'));
  done.appendChild(closeBtn);
  box.appendChild(done);
  document.getElementById('shopPanel').classList.remove('hidden');
}

/* Shop panel (non-edit) */
function openShop(i){
  const r = recipes[i]; if(!r) return;
  document.getElementById('shopTitle').textContent = r.name + ' — Shopping';
  const box = document.getElementById('shopItems'); box.innerHTML = '';
  r.shoppingList.forEach((it, idx)=>{
    const div = document.createElement('div'); div.className='shopping-item';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!it.checked;
    cb.addEventListener('change', ()=>{ r.shoppingList[idx].checked = cb.checked; saveAll(); });
    const txt = document.createElement('div'); txt.textContent = it.item;
    div.appendChild(cb); div.appendChild(txt); box.appendChild(div);
  });
  const editBtn = document.createElement('button'); editBtn.textContent='Edit Ingredients'; editBtn.className='small-btn'; editBtn.style.marginTop='8px';
  editBtn.addEventListener('click', ()=> openRecipeDetails(findRecipeIndexByName(r.name)));
  box.appendChild(editBtn);
  document.getElementById('shopPanel').classList.remove('hidden');
}
document.getElementById('closeShopBtn').addEventListener('click', ()=> document.getElementById('shopPanel').classList.add('hidden'));
document.getElementById('clearShopBtn').addEventListener('click', ()=>{
  const title = document.getElementById('shopTitle').textContent; const name = title.replace(' — Shopping','');
  const idx = recipes.findIndex(x=>x.name===name); if (idx<0) return;
  recipes[idx].shoppingList = recipes[idx].shoppingList.filter(it=>!it.checked); saveAll(); openShop(idx); renderRecipes();
});
function findRecipeIndexByName(name){ return recipes.findIndex(x=>x.name===name); }

/* Nutrition calculations & per-step attribution */
function computeNutritionForRecipe(recipe){
  const totals={cal:0,protein:0,carbs:0,fat:0};
  const parsed = recipe.ingredients.map(line=>parseIngredientLine(line));
  const perIngredient = parsed.map(p=>{
    if (!p || !p.quantity) return {p,cal:0,protein:0,carbs:0,fat:0,matched:false};
    const key = matchNutritionKey(p.name);
    if (!key) return {p,cal:0,protein:0,carbs:0,fat:0,matched:false};
    const db = BIG_NUTRITION_DB[key];
    if (!db) return {p,cal:0,protein:0,carbs:0,fat:0,matched:false};
    let grams = p.quantity;
    if (p.quantity_unit === 'ml') grams = p.quantity; // approx heuristic
    const factor = grams/100;
    const cal = (db.cal||0)*factor;
    const protein = (db.protein||0)*factor;
    const carbs = (db.carbs||0)*factor;
    const fat = (db.fat||0)*factor;
    totals.cal += cal; totals.protein += protein; totals.carbs += carbs; totals.fat += fat;
    return {p,cal,protein,carbs,fat,matched:true,dbKey:key};
  });
  totals.cal = Math.round(totals.cal);
  totals.protein = Math.round(totals.protein*10)/10;
  totals.carbs = Math.round(totals.carbs*10)/10;
  totals.fat = Math.round(totals.fat*10)/10;
  return {totals, perIngredient};
}

function computePerRecipeNutritionMap(recipe){
  const info = computeNutritionForRecipe(recipe);
  const perIng = info.perIngredient;
  const stepsCount = Math.max(1, recipe.instructions.length);
  const perStep = Array.from({length:stepsCount}, ()=>({cal:0,protein:0,carbs:0,fat:0}));
  perIng.forEach(ingObj=>{
    if (!ingObj || (!ingObj.cal && !ingObj.protein && !ingObj.carbs && !ingObj.fat)) return;
    let matched=false;
    if (ingObj.dbKey){
      for (let s=0;s<stepsCount;s++){
        const stepText = (recipe.instructions[s].step||'').toLowerCase();
        if (stepText.includes(ingObj.dbKey)){ perStep[s].cal+=ingObj.cal; perStep[s].protein+=ingObj.protein; perStep[s].carbs+=ingObj.carbs; perStep[s].fat+=ingObj.fat; matched=true; break; }
      }
    }
    if (!matched){
      const nameLower = (ingObj.p.name||'').toLowerCase();
      const first = nameLower.split(' ')[0];
      for (let s=0;s<stepsCount;s++){
        if ((recipe.instructions[s].step||'').toLowerCase().includes(first)){ perStep[s].cal+=ingObj.cal; perStep[s].protein+=ingObj.protein; perStep[s].carbs+=ingObj.carbs; perStep[s].fat+=ingObj.fat; matched=true; break; }
      }
    }
    ingObj.matched = matched;
  });
  const unmatched = perIng.filter(i=>i && !i.matched && (i.cal||i.protein||i.carbs||i.fat));
  if (unmatched.length){
    const sum = unmatched.reduce((acc,i)=>{ acc.cal+=i.cal; acc.protein+=i.protein; acc.carbs+=i.carbs; acc.fat+=i.fat; return acc; }, {cal:0,protein:0,carbs:0,fat:0});
    const each = {cal: sum.cal/stepsCount, protein: sum.protein/stepsCount, carbs: sum.carbs/stepsCount, fat: sum.fat/stepsCount};
    for (let s=0;s<stepsCount;s++){
      perStep[s].cal += each.cal; perStep[s].protein += Math.round(each.protein*10)/10; perStep[s].carbs += Math.round(each.carbs*10)/10; perStep[s].fat += Math.round(each.fat*10)/10;
    }
  }
  for (let s=0;s<perStep.length;s++){
    perStep[s].cal = Math.round(perStep[s].cal);
    perStep[s].protein = Math.round(perStep[s].protein*10)/10;
    perStep[s].carbs = Math.round(perStep[s].carbs*10)/10;
    perStep[s].fat = Math.round(perStep[s].fat*10)/10;
  }
  recipe._perStepNutrition = perStep;
  recipe._nutritionTotals = info.totals;
  return {perStep, totals: info.totals};
}

/* compute & show for currently built recipe (with scaling) */
function computeAndShowNutrition(recipeObj){
  const info = computePerRecipeNutritionMap(recipeObj);
  document.getElementById('generatedArea').classList.remove('hidden');
  const displayServ = Number(document.getElementById('displayServings').value) || recipeObj.servings || 1;
  const scale = displayServ / (recipeObj.servings || 1);
  const totalsScaled = { cal: Math.round(info.totals.cal*scale), protein: Math.round(info.totals.protein*10*scale)/10, carbs: Math.round(info.totals.carbs*10*scale)/10, fat: Math.round(info.totals.fat*10*scale)/10 };
  document.getElementById('nutritionSummary').textContent = `Totals (scaled): ${totalsScaled.cal} kcal • P ${totalsScaled.protein} g • C ${totalsScaled.carbs} g • F ${totalsScaled.fat} g`;
  const perStepDiv = document.getElementById('perStepNutrition'); perStepDiv.innerHTML='';
  info.perStep.forEach((sNut, idx)=>{
    const sScaled = { cal: Math.round(sNut.cal*scale), protein: Math.round(sNut.protein*10*scale)/10, carbs: Math.round(sNut.carbs*10*scale)/10, fat: Math.round(sNut.fat*10*scale)/10 };
    const div = document.createElement('div'); div.innerHTML = `<div style="margin-bottom:4px;"><strong>Step ${idx+1}:</strong> ${recipeObj.instructions[idx].step} ${recipeObj.instructions[idx].time?`[${recipeObj.instructions[idx].time}m]`:''}</div><div class="step-nut">Estimated (scaled): ${sScaled.cal} kcal • P ${sScaled.protein} g • C ${sScaled.carbs} g • F ${sScaled.fat} g</div>`;
    perStepDiv.appendChild(div);
  });
}

/* Update when displayServings changes */
document.getElementById('displayServings').addEventListener('input', ()=>{
  const name = (document.getElementById('recipeName').value||'Preview').trim();
  const ingredientLines = (document.getElementById('ingredients').value||'').trim().split('\n').map(l=>l.trim()).filter(Boolean);
  const instLines = (document.getElementById('instructions').value||'').trim().split('\n').map(line=>{ const tm=line.match(/\[(\d+)m\]/); return {step: line.replace(/\[\d+m\]/,'').trim(), time: tm?parseInt(tm[1],10):0}; });
  if (!ingredientLines.length || !instLines.length) return;
  const preview = { name, servings: Number(document.getElementById('baseServings').value)||1, ingredients: ingredientLines, instructions: instLines };
  computeAndShowNutrition(preview);
});

/* Cook Mode */
let cookIndex=null, stepIndex=0, stepTimer=null, remainingSec=0;
const cookPanel = document.getElementById('cookPanel');

function openCook(i){
  cookIndex=i; stepIndex=0; showCookStep(); cookPanel.classList.remove('hidden'); cookPanel.scrollIntoView({behavior:'smooth'});
}
function showCookStep(){
  clearInterval(stepTimer);
  if (cookIndex==null) return;
  const recipe = recipes[cookIndex];
  const inst = recipe.instructions[stepIndex];
  document.getElementById('cookTitle').textContent = recipe.name;
  document.getElementById('cookProgress').textContent = `Step ${stepIndex+1} / ${recipe.instructions.length}`;
  document.getElementById('stepText').textContent = inst.step;
  computePerRecipeNutritionMap(recipe);
  const displayServ = Number(document.getElementById('displayServings').value) || recipe.servings || 1;
  const scale = displayServ / (recipe.servings || 1);
  const perStep = (recipe._perStepNutrition && recipe._perStepNutrition[stepIndex]) || {cal:0,protein:0,carbs:0,fat:0};
  const perStepScaled = { cal: Math.round(perStep.cal*scale), protein: Math.round(perStep.protein*10*scale)/10, carbs: Math.round(perStep.carbs*10*scale)/10, fat: Math.round(perStep.fat*10*scale)/10 };
  document.getElementById('stepNutritionText').textContent = `This step (scaled): ${perStepScaled.cal} kcal • P ${perStepScaled.protein} g • C ${perStepScaled.carbs} g • F ${perStepScaled.fat} g`;
  if (inst.time && inst.time>0){
    remainingSec = inst.time * 60; updateTimerText();
    stepTimer = setInterval(()=>{ remainingSec--; updateTimerText(); if (remainingSec<=0){ clearInterval(stepTimer); alert('Timer done: ' + inst.step); } },1000);
  } else { document.getElementById('timerText').textContent = ''; }
}
function updateTimerText(){ const m=Math.floor(remainingSec/60), s=remainingSec%60; document.getElementById('timerText').textContent = `Time left: ${m}:${s.toString().padStart(2,'0')}`; }
document.getElementById('nextStepBtn').addEventListener('click', ()=>{ if(cookIndex==null) return; if(stepIndex<recipes[cookIndex].instructions.length-1){ stepIndex++; showCookStep(); } else { alert('Recipe complete!'); closeCook(); } });
document.getElementById('prevStepBtn').addEventListener('click', ()=>{ if(cookIndex==null) return; if(stepIndex>0){ stepIndex--; showCookStep(); } });
document.getElementById('stopCookBtn').addEventListener('click', closeCook);
function closeCook(){ clearInterval(stepTimer); cookIndex=null; stepIndex=0; cookPanel.classList.add('hidden'); }

/* Printing */
function buildRecipeHTMLForPrint(r, displayServings){
  const scale = (displayServings || r.servings) / (r.servings || 1);
  const ingredientsHTML = r.ingredients.map(line => `<li>${formatIngredientForDisplay(line, scale)}</li>`).join('');
  const stepsHTML = r.instructions.map(s => `<li>${s.step}${s.time?` — ${s.time} min`:''}</li>`).join('');
  const nutrition = computePerRecipeNutritionMap(r).totals;
  const nutritionScaled = { cal: Math.round(nutrition.cal*scale), protein: Math.round(nutrition.protein*10*scale)/10, carbs: Math.round(nutrition.carbs*10*scale)/10, fat: Math.round(nutrition.fat*10*scale)/10 };
  const nutritionHTML = `<p>Calories: ${nutritionScaled.cal} kcal • Protein: ${nutritionScaled.protein} g • Carbs: ${nutritionScaled.carbs} g • Fat: ${nutritionScaled.fat} g</p>`;
  return `<div style="font-family:Arial;color:#111"><h1>${r.name}</h1>
    <p><strong>Serves:</strong> ${displayServings || r.servings}</p>
    ${nutritionHTML}
    <h3>Ingredients</h3><ul>${ingredientsHTML}</ul>
    <h3>Steps</h3><ol>${stepsHTML}</ol>
    </div>`;
}
function printRecipe(i){
  const r = recipes[i]; if(!r) return;
  const displayServ = Number(document.getElementById('displayServings').value) || r.servings || 1;
  document.getElementById('printContent').innerHTML = buildRecipeHTMLForPrint(r, displayServ);
  document.getElementById('printView').classList.remove('hidden');
  setTimeout(()=>{ window.print(); document.getElementById('printView').classList.add('hidden'); },250);
}
document.getElementById('printRecipeBtn').addEventListener('click', ()=>{
  const name = (document.getElementById('recipeName').value||'Preview').trim();
  const ingredientLines = (document.getElementById('ingredients').value||'').trim().split('\n').filter(Boolean);
  const instLines = (document.getElementById('instructions').value||'').trim().split('\n').filter(Boolean).map(line=>{ const tm=line.match(/\[(\d+)m\]/); return {step:line.replace(/\[\d+m\]/,'').trim(), time: tm?parseInt(tm[1],10):0}; });
  const preview = { name, servings: Number(document.getElementById('baseServings').value)||1, ingredients: ingredientLines, instructions:instLines };
  document.getElementById('printContent').innerHTML = buildRecipeHTMLForPrint(preview, Number(document.getElementById('displayServings').value) || preview.servings);
  document.getElementById('printView').classList.remove('hidden');
  setTimeout(()=>{ window.print(); document.getElementById('printView').classList.add('hidden'); },250);
});

/* Export/Import removed as requested */

/* Misc UI bindings */
document.getElementById('toggleUnitsBtn').addEventListener('click', ()=>{ UNIT_SYSTEM = (UNIT_SYSTEM==='metric'?'imperial':'metric'); setUnitSystem(UNIT_SYSTEM); });
document.getElementById('search').addEventListener('input', renderRecipes);
document.getElementById('refreshBtn').addEventListener('click', renderRecipes);
document.getElementById('randomSuggest').addEventListener('click', ()=>{ if(!recipes.length) return alert('No recipes'); const r=recipes[Math.floor(Math.random()*recipes.length)]; alert('Try: '+r.name); });
document.getElementById('importSample').addEventListener('click', ()=>{ const sample={ name:'Quick Veg Stir', servings:2, ingredients:['150 g broccoli','100 g carrot','15 ml soy sauce','10 ml olive oil'], instructions:[{step:'Chop veg',time:0},{step:'Stir fry',time:6}], shoppingList:[{item:'150 g broccoli',checked:false},{item:'100 g carrot',checked:false}], created:Date.now() }; recipes.unshift(sample); saveAll(); renderRecipes(); });

/* expose inline handlers */
window.openCook = openCook; window.openShop = openShop; window.editRecipe = editRecipe; window.deleteRecipe = deleteRecipe; window.printRecipe = printRecipe; window.openRecipeDetails = openRecipeDetails;

/* init */
setUnitSystem(UNIT_SYSTEM);
renderRecipes();

/* Help overlay logic */
const helpOverlay = document.getElementById('helpOverlay');
function openHelp(){ helpOverlay.classList.remove('hidden'); helpOverlay.setAttribute('aria-hidden','false'); window.scrollTo({top:0}); document.getElementById('mainApp').scrollIntoView(); }
function closeHelp(){ helpOverlay.classList.add('hidden'); helpOverlay.setAttribute('aria-hidden','true'); }
document.getElementById('helpOpenBtn').addEventListener('click', ()=>{ openHelp(); });
document.getElementById('helpCloseTop').addEventListener('click', closeHelp);
document.getElementById('backToAppBtn').addEventListener('click', closeHelp);
document.getElementById('backToAppBtn2').addEventListener('click', closeHelp);

/* First-time tip — show once, then again after 30 days */
const FIRST_TIP_KEY = 'first_tip_shown_vgen';
function showFirstTipIfNeeded(){
  try{
    const stored = localStorage.getItem(FIRST_TIP_KEY);
    if (!stored){
      document.getElementById('firstTip').classList.remove('hidden');
      return;
    }
    const ts = parseInt(stored,10) || 0;
    const now = Date.now();
    const days30 = 30 * 24 * 3600 * 1000;
    if (now - ts > days30){
      document.getElementById('firstTip').classList.remove('hidden');
    }
  }catch(e){ console.warn(e); document.getElementById('firstTip').classList.remove('hidden'); }
}
document.getElementById('openHelpFromTip').addEventListener('click', ()=>{ document.getElementById('firstTip').classList.add('hidden'); openHelp(); localStorage.setItem(FIRST_TIP_KEY, Date.now().toString()); });
document.getElementById('dismissTip').addEventListener('click', ()=>{ document.getElementById('firstTip').classList.add('hidden'); localStorage.setItem(FIRST_TIP_KEY, Date.now().toString()); });
showFirstTipIfNeeded();

/* Accessibility: ESC closes help */
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape'){ if (!helpOverlay.classList.contains('hidden')) closeHelp(); } });

/* End of script */
</script>
</body>
</html>
